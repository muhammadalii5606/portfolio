{% load static %}
{% load i18n %}

<section class="mh-about" id="mh-about">
    <div class="container">
        <div class="row section-separator">
            <div class="col-sm-12 col-md-6">
                <div class="mh-about-img shadow-2 wow fadeInUp" data-wow-duration="0.8s" data-wow-delay="0.4s">
                    <img src="{% static 'assets/images/ab-img.png' %}" alt="" class="img-fluid">
                </div>
            </div>
            <div class="col-sm-12 col-md-6">
                <div class="mh-about-inner">
                    <h2 class="wow fadeInUp" data-wow-duration="0.8s" data-wow-delay="0.1s">{% trans 'About Me' %}</h2>
                    <p class="wow fadeInUp" data-wow-duration="0.8s" data-wow-delay="0.2s">
Hi! I'm a backend developer with a passion for building robust, scalable, and efficient server-side applications.
I focus on writing clean, maintainable code and designing architectures that are both efficient and future-proof.
I enjoy solving complex problems and creating reliable systems that power modern web experiences.</p>

                    <div class="mh-about-tag wow fadeInUp" data-wow-duration="0.8s" data-wow-delay="0.3s">
                        <ul>
                            {% for skill in tech_skills %}
                                <li><span>{{ skill }}</span></li>
                            {% endfor %}
                        </ul>
                    </div>

                    <!-- ============================================ -->
                    <!-- ✅ SODDA DOWNLOAD CV -->
                    <!-- ============================================ -->

                    <div class="cv-download-section mt-4">
                        <!-- 1. ASOSIY TUGMA -->
                        <button id="show-recaptcha-btn"
                                class="btn btn-primary btn-lg"
                                style="font-weight: bold; padding: 12px 30px;">
                            <i class="fa fa-download"></i> {% trans 'Download CV' %}
                        </button>

                        <!-- 2. RECAPTCHA (YASHIRIN) -->
                        <div id="recaptcha-container" class="mt-3" style="display: none;">
                            <!-- reCAPTCHA -->
                            <div class="mb-3">
                                <div class="g-recaptcha"
                                     data-sitekey="6LfzCygsAAAAAKns4sIp-FebWZpD7ZuDvUjXzvWt"
                                     data-callback="onRecaptchaVerified"
                                     data-size="normal"
                                     data-theme="light">
                                </div>
                                <small class="text-muted">
                                    <i class="fa fa-shield-alt"></i> {% trans 'Verify you are human' %}
                                </small>
                            </div>

                            <!-- BEKOR QILISH -->
                            <button id="cancel-btn" class="btn btn-outline-secondary btn-sm">
                                <i class="fa fa-times"></i> {% trans 'Cancel' %}
                            </button>
                        </div>

                        <!-- 3. LOADING (YASHIRIN) -->
                        <div id="loading-indicator" class="mt-3 text-center" style="display: none;">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="text-muted mt-2 mb-0">
                                <i class="fa fa-file-pdf"></i> {% trans 'CV is being prepared...' %}
                            </p>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</section>

<!-- ============================================ -->
<!-- ✅ RECAPTCHA SCRIPT -->
<!-- ============================================ -->
<script src="https://www.google.com/recaptcha/api.js" async defer></script>

<script>
// ==================== MAIN FLOW ====================

// 1. Download CV bosilganda
document.getElementById('show-recaptcha-btn').addEventListener('click', function() {
    console.log("Download CV clicked");

    // Asosiy tugmani yashirish
    this.style.display = 'none';

    // reCAPTCHA ni ko'rsatish
    document.getElementById('recaptcha-container').style.display = 'block';
});

// 2. Bekor qilish
document.getElementById('cancel-btn').addEventListener('click', function() {
    console.log("Cancelled");

    // reCAPTCHA ni yashirish
    document.getElementById('recaptcha-container').style.display = 'none';

    // Asosiy tugmani ko'rsatish
    document.getElementById('show-recaptcha-btn').style.display = 'inline-block';

    // reCAPTCHA ni reset qilish
    if (typeof grecaptcha !== 'undefined') {
        grecaptcha.reset();
    }
});

// 3. reCAPTCHA tasdiqlanganda
function onRecaptchaVerified(token) {
    console.log("reCAPTCHA verified");

    // reCAPTCHA ni yashirish
    document.getElementById('recaptcha-container').style.display = 'none';

    // Loading ko'rsatish
    document.getElementById('loading-indicator').style.display = 'block';

    // Serverga so'rov yuborish
    downloadCV(token);
}

// ==================== DOWNLOAD FUNCTION ====================

function downloadCV(token) {
    console.log("Starting download...");

    // Form yaratish
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{% url "pages:download_cv" %}';
    form.style.display = 'none';

    // CSRF token
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
    form.appendChild(csrfInput);

    // reCAPTCHA token
    const recaptchaInput = document.createElement('input');
    recaptchaInput.type = 'hidden';
    recaptchaInput.name = 'g-recaptcha-response';
    recaptchaInput.value = token;
    form.appendChild(recaptchaInput);

    // Formni yuborish
    document.body.appendChild(form);

    // Fetch API orqali yuborish (PDF yuklash uchun)
    fetch(form.action, {
        method: 'POST',
        body: new FormData(form),
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (response.ok && response.headers.get('content-type')?.includes('application/pdf')) {
            // PDF ni yuklash
            return response.blob();
        }
        throw new Error('Download failed');
    })
    .then(blob => {
        // PDF faylni yuklash
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'MuhammadAlis_resume.pdf';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);

        console.log("✅ CV downloaded successfully");

        // Hammasini reset qilish
        setTimeout(resetAll, 1000);
    })
    .catch(error => {
        console.error("Download error:", error);

        // Xatolik xabarini ko'rsatish
        document.getElementById('loading-indicator').innerHTML = `
            <div class="alert alert-danger">
                <i class="fa fa-exclamation-triangle"></i> Download failed. Please try again.
            </div>
            <button onclick="resetAll()" class="btn btn-sm btn-outline-danger mt-2">
                Try Again
            </button>
        `;
    });
}

// ==================== HELPER FUNCTIONS ====================

function resetAll() {
    console.log("Resetting all...");

    // Loading ni yashirish
    document.getElementById('loading-indicator').style.display = 'none';
    document.getElementById('loading-indicator').innerHTML = `
        <div class="spinner-border text-primary" role="status"></div>
        <p class="text-muted mt-2 mb-0">
            <i class="fa fa-file-pdf"></i> {% trans 'CV is being prepared...' %}
        </p>
    `;

    // Asosiy tugmani ko'rsatish
    document.getElementById('show-recaptcha-btn').style.display = 'inline-block';

    // reCAPTCHA ni reset qilish
    if (typeof grecaptcha !== 'undefined') {
        grecaptcha.reset();
    }
}

// ==================== INITIALIZATION ====================

document.addEventListener('DOMContentLoaded', function() {
    console.log("CV Download system ready");
});
</script>

<!-- CSS STYLES -->
<style>
.cv-download-section {
    transition: all 0.3s ease;
}
#show-recaptcha-btn {
    transition: all 0.3s ease;
}
#show-recaptcha-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 123, 255, 0.3);
}
.g-recaptcha {
    margin: 10px 0;
}
/* reCAPTCHA to'g'ri ko'rinishi uchun */
iframe[title="reCAPTCHA"] {
    display: block !important;
}
</style>

